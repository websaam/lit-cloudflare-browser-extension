<div class="lit-video-wrapper">
    <iframe 
        src=""
        class="lit-video"
        allow="accelerometer; gyroscope; 
        autoplay; encrypted-media; 
        picture-in-picture;" 
        allowfullscreen="true"
        data-lit="eyJhY2Nlc3NDb250cm9sQ29uZGl0aW9ucyI6Ilczc2lZMjl1ZEhKaFkzUkJaR1J5WlhOeklqb2lJaXdpYzNSaGJtUmhjbVJEYjI1MGNtRmpkRlI1Y0dVaU9pSWlMQ0pqYUdGcGJpSTZJbVYwYUdWeVpYVnRJaXdpYldWMGFHOWtJam9pSWl3aWNHRnlZVzFsZEdWeWN5STZXeUk2ZFhObGNrRmtaSEpsYzNNaVhTd2ljbVYwZFhKdVZtRnNkV1ZVWlhOMElqcDdJbU52YlhCaGNtRjBiM0lpT2lJOUlpd2lkbUZzZFdVaU9pSXdlREE1WkRGRE1Ua3pZVVZET1RsR1FUQXhPVE5ETkRreE0yTTNRa1F3T1RSR016SXlPRGt6WVRNaWZYMWQiLCJlbmNyeXB0ZWRaaXAiOiJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsbU1UKzNvem4yRk9JWXFYOXl5WVdDcU94TVFhbHpxYVFkRFRUc1ZuYXhwNDhPRXRJVXZEb0NsRyttSHFLSHNvV2paOFhJTmdOalRxbktVUGZrdGpDQUtDY2NpQW9RbTNKOWZUblNDdFl3WmI0OGh2Z0EzdFBHQVpSU1NHNkRaVTlZWWY0S0lqa0xEZmxxWWFWVlhGd2IwYnIxdTF6NkNjcHVGN3JPcXk4SU5YZkUrZjV2bTYrKys2L3YvS1FZYUJHUFFKKzBoZDh3L1UwVHpPOEZKL1NWTEdhYkpybStzUGZlN210eUUxMnVtMD0iLCJlbmNyeXB0ZWRTeW1tZXRyaWNLZXkiOiJNVEEyTERZekxERTJNeXd5Tnl3eE5UY3NNakl4TERrMkxEZzJMREUxT1N3eE1EQXNNVFFzTXpJc01UUTVMRE0zTERJek5TdzROeXd5TURjc01UUXpMREl5TUN3ekxERTVNeXd4TXpjc01qTTBMREV4TlN3eE9UZ3NNakUwTERJeE5DdzVNaXcxTnl3eE9UY3NOekVzTkRNc01UZ3pMREV5TUN3eU9Td3lMREU0TERnekxEZ3hMREV3T1N3eE56TXNNVGsyTERFek1pd3lNVEFzTmpnc016Z3NOVGNzTWpVc01UUXpMREl3TWl3eE5USXNNakUwTERNeExETTFMREV3T1N3eU1Dd3lNRGNzTWpVeUxERTFOU3cxTVN3eE16Y3NNakE0TERJd015d3hPRE1zTkN3eE9EUXNNVFkyTERrMExETTNMREl6TXl3ek5pdzVPU3d4T1N3eE1USXNNakkwTERJek1pdzRMRE0wTERRNUxEY3hMRGM1TERFek15dzNOeXczTlN3eE9DdzBPU3d4TWpNc01qQXlMREl6T0N3eE16Z3NNVEUyTERFeU1pd3hOek1zTWpFc01UZ3NNVFl3TERNMkxERTBNeXd5TURZc01UUTRMREkxTXl3NU5Td3hOREFzTWprc01qSTVMRGcwTERZc09EY3NNVGNzTkRZc09UVXNOaklzTVRrNExERXlOaXd4T1RVc01UUXNPVElzTWpFMkxERTNNeXd4T1RNc05Ua3NNVGdzT1RBc01qTTVMREU1TlN3eE1ERXNOQ3d4TURBc01Dd3dMREFzTUN3d0xEQXNNQ3d6TWl3M0xEUXdMREl3TVN3NE5TdzFOeXd5TVRZc01UazVMRGM0TERFd0xESTNMREU1Tnl3eE9ETXNNakUzTERVMUxERXhOaXd4TkRFc016TXNNak15TERRekxERTJPQ3d5TlRJc01UQTBMREkwT0N3eU5UTXNNalFzT1Rrc01UY3pMREl5TUN3eU1EQXNNVEFzTWpNMkxESXdPQ3d4TURjc01UZ3dMREV5TkN3eU1UVXNNVEkyTERjekxESXhNaXd4Tmprc01Ua3NNVEF6TERFeU9Td3hPVEFzTWpjc01qQTVMREl4TUN3eE16UT0ifQ==">
    </iframe>
    <button class="btn-lit-video-unlock">Unlock</button>
</div>

<script>

    // ----- helper
    //
    // convert data URI to blob
    // @param { String } dataURI
    // @return { Blob } blob object
    //
    function dataURItoBlob(dataURI) {
        var byteString = atob(dataURI.split(',')[1]);
        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
        var ab = new ArrayBuffer(byteString.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }
        var blob = new Blob([ab], {type: mimeString});
        return blob;
    }
    function buf2hex(buffer) {
        return [...new Uint8Array(buffer)]
            .map((x) => x.toString(16).padStart(2, "0"))
            .join("");
    }
    
    // ----- unlock
    async function unlock(e){
        var data = JSON.parse(atob(e.getAttribute('data-lit')));

        const accessControlConditions = JSON.parse(atob(data['accessControlConditions']));
        // console.log(accessControlConditions)
        const encryptedZip = dataURItoBlob(data['encryptedZip']);
        const toDecrypt = buf2hex(new Uint8Array(atob(data['encryptedSymmetricKey']).split(',').map((x) => parseInt(x))));
        const chain = accessControlConditions[0].chain;
        const authSig = await LitJsSdk.checkAndSignAuthMessage({chain: chain});
        
        const decryptedSymmetricKey = await window.litNodeClient.getEncryptionKey({
            accessControlConditions,
            toDecrypt,
            chain,
            authSig
        });

        const decryptedFiles = await LitJsSdk.decryptZip(encryptedZip, decryptedSymmetricKey);
        const decryptedString = await decryptedFiles["string.txt"].async("text"); // video id

        const url = `https://iframe.videodelivery.net/${decryptedString}`;
        e.src = url;
    }

    (() => {
        var btns = document.getElementsByClassName('btn-lit-video-unlock');
        [...btns].forEach((btn) => {
            btn.addEventListener('click', (e) => {
                unlock(e.target.parentElement.querySelector('iframe'));
            });
        });
        // [...document.getElementsByClassName('btn-lit-video-unlock')].forEach((btn) => {
        //     // var wrapper = document.createElement('div');
        //     // wrapper.classList.add('lit-video-wrapper');
        //     // wrapper.appendChild(e);
        //     console.log(btn);
        // });
    })();
</script>

<script
    onload="LitJsSdk.litJsSdkLoadedInALIT()"
    src="https://jscdn.litgateway.com/index.web.js"
></script>